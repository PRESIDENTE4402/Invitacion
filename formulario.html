<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <title>ConfirmaciÃ³n de asistencia</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/style_formulario.css" />
    <!-- Google Fonts opcionales -->
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600&family=Lora&family=Great+Vibes&display=swap"
        rel="stylesheet">
</head>

<body>
    <main class="page">
        <section class="card">
            <h1 class="title-script">ConfirmaciÃ³n de asistencia</h1>
            <p class="subtitle">Por favor indÃ­canos de parte de quiÃ©n vienes.</p>

            <!-- CARDS NOVIA / NOVIO -->
            <div class="rsvp-cards">
                <button type="button" class="rsvp-card" data-side="novia">
                    <h3>Invitado de la novia</h3>
                    <p>Familia y amigos de la novia</p>
                </button>

                <button type="button" class="rsvp-card" data-side="novio">
                    <h3>Invitado del novio</h3>
                    <p>Familia y amigos del novio</p>
                </button>
            </div>

            <!-- FORMULARIO (INICIALMENTE OCULTO) -->
            <form id="rsvpForm" class="rsvp-form is-hidden">
                <p class="rsvp-form-title">
                    EstÃ¡s confirmando como <span id="selectedSideLabel"></span>
                </p>

                <!-- guarda si viene de la novia o del novio -->
                <input type="hidden" id="sideHidden" name="side" />

                <div class="field autocomplete">
                    <label for="guestName">Escribe tu nombre</label>
                    <input type="text" id="nombreInput" name="nombreInput" autocomplete="off"
                        placeholder="Empieza a escribir tu nombreâ€¦">
                    <ul id="suggestions" class="suggestions-list"></ul>
                </div>
                <!-- Caja que aparece cuando NO se encuentra el nombre -->
                <div id="notFoundBox" class="not-found hidden">
                    <p>No encontramos tu nombre en la lista.<br>
                        Por favor contacta a:</p>

                    <div class="notfound-buttons">
                        <a href="https://wa.me/50258223192?" target="_blank" class="nf-btn novia">La Novia ðŸ’›</a>
                        <a href="https://wa.me/50233970345?" target="_blank" class="nf-btn novio">El Novio ðŸ¤µ</a>
                    </div>
                </div>

                <div id="guestCountBox" class="guest-count hidden">
                    <label>Pase unicamente para</label>

                    <div class="counter">
                        <button type="button" id="btnMinus" class="btn-counter">âˆ’</button>
                        <input type="number" id="guestCount" value="1" readonly>
                        <button type="button" id="btnPlus" class="btn-counter disabled" disabled>+</button>
                    </div>

                    <p id="guestLimitLabel" class="guest-limit"></p>
                </div>


                <!-- <div class="field">
                    <label for="extraInfo">Mensaje (opcional)</label>
                    <textarea id="extraInfo" name="extraInfo" rows="3"
                        placeholder="Ej. AcompaÃ±arÃ© solo / LlevarÃ© a mis hijos / Alguna aclaraciÃ³n especial"></textarea>
                </div> -->

                <button type="submit" class="btn-primary">
                    Confirmar asistencia
                </button>
            </form>
        </section>
    </main>
    <!-- âš ï¸ MODAL ELEGANTE DE CONFIRMACIÃ“N -->
    <div id="niceAlert" class="nice-alert hidden">
        <div class="nice-alert-backdrop"></div>

        <div class="nice-alert-box">
            <h3 id="niceAlertTitle">Â¡Gracias!</h3>
            <p id="niceAlertMessage">Tu confirmaciÃ³n fue recibida.</p>

            <button id="niceAlertBtn" class="nice-alert-btn">Aceptar</button>
        </div>
    </div>

    <!-- JS -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // ============================
            // 1) LISTAS DE INVITADOS
            // ============================
            const invitados = {
                novia: [
                    { nombre: "ESMERALDA DE CABALLEROS", cantidad: 1 },
                    { nombre: "BYRON GONZÃLEZ", cantidad: 2 },
                    { nombre: "FREDY GONZÃLEZ", cantidad: 4 },
                    { nombre: "LUIS GONZÃLEZ", cantidad: 3 }
                ],
                novio: [
                    { nombre: "ARMANDO RODRÃGUEZ", cantidad: 2 },
                    { nombre: "YOSELIN CASTILLO", cantidad: 1 },
                    { nombre: "LUIS FERNANDO CASTILLO", cantidad: 3 },
                    { nombre: "LOURDES CASTILLO", cantidad: 5 }
                ]
            };

            // ============================
            // 2) ELEMENTOS DEL DOM
            // ============================
            const cards = document.querySelectorAll(".rsvp-card");
            const form = document.getElementById("rsvpForm");
            const guestInput = document.getElementById("nombreInput");
            const suggestionBox = document.getElementById("suggestions");
            const notFoundBox = document.getElementById("notFoundBox");
            const sideHidden = document.getElementById("sideHidden");
            const sideLabel = document.getElementById("selectedSideLabel");
            const extraInfo = document.getElementById("extraInfo");
            const guestCountBox = document.getElementById("guestCountBox");
            const guestCountInput = document.getElementById("guestCount");


            // Si falta algo crÃ­tico, no seguimos para evitar errores
            if (!form || !guestInput || !suggestionBox || !sideHidden || !sideLabel) {
                console.error("Faltan elementos necesarios en el DOM para el formulario de RSVP.");
                return;
            }

            // Lista actual (novia / novio)
            let listaActiva = [];
            // Busca el invitado por el texto escrito y muestra la cantidad (si coincide exactamente)
            function aplicarCantidadPorNombre() {
                if (!guestInput || !listaActiva.length) return;

                const nombreEscrito = guestInput.value.trim().toLowerCase();
                if (!nombreEscrito) return;

                const invitadoObj = listaActiva.find(inv =>
                    inv.nombre.toLowerCase() === nombreEscrito
                );

                if (invitadoObj) {
                    mostrarCantidad(invitadoObj.cantidad);
                }
            }


            // ============================
            // 3) CLICK EN UNA CARD
            // ============================
            cards.forEach(card => {
                card.addEventListener("click", () => {
                    const side = card.dataset.side; // "novia" o "novio"

                    // marcar visualmente
                    cards.forEach(c => c.classList.remove("is-active"));
                    card.classList.add("is-active");

                    // texto visible
                    sideLabel.textContent = side === "novia"
                        ? "invitado de la novia"
                        : "invitado del novio";

                    // guardar lado seleccionado
                    sideHidden.value = side;

                    // activar lista correspondiente
                    listaActiva = invitados[side] || [];

                    // limpiar input y sugerencias
                    guestInput.value = "";
                    suggestionBox.innerHTML = "";
                    suggestionBox.style.display = "none";
                    if (notFoundBox) notFoundBox.classList.add("hidden");
                    if (guestCountBox) guestCountBox.classList.add("hidden");

                    // mostrar formulario
                    form.classList.remove("is-hidden");
                    form.scrollIntoView({ behavior: "smooth", block: "start" });
                });
            });

            // ============================
            // 4) AUTOCOMPLETE DEL NOMBRE
            // ============================
            guestInput.addEventListener("input", function () {
                const query = this.value.toLowerCase().trim();
                suggestionBox.innerHTML = "";
                suggestionBox.style.display = "none";
                if (notFoundBox) notFoundBox.classList.add("hidden");

                if (!query || listaActiva.length === 0) {
                    return;
                }

                // Filtrar por nombre del objeto
                const matches = listaActiva.filter(invitado =>
                    invitado.nombre.toLowerCase().includes(query)
                );

                if (matches.length === 0) {
                    // si quieres mostrar el aviso de "no estÃ¡s en la lista" mientras escribe,
                    // descomenta la siguiente lÃ­nea:
                    // if (notFoundBox) notFoundBox.classList.remove("hidden");
                    return;
                }

                matches.forEach(invitado => {
                    const li = document.createElement("li");
                    li.textContent = invitado.nombre;

                    li.addEventListener("click", () => {
                        guestInput.value = invitado.nombre;
                        suggestionBox.innerHTML = "";
                        suggestionBox.style.display = "none";

                        // MOSTRAR CANTIDAD (contador que solo puede disminuir)
                        mostrarCantidad(invitado.cantidad);
                    });

                    suggestionBox.appendChild(li);
                });

                suggestionBox.style.display = "block";
            });

            // Ocultar sugerencias si clic fuera del autocomplete
            document.addEventListener("click", (e) => {
                if (!e.target.closest(".autocomplete")) {
                    suggestionBox.style.display = "none";
                }
            });
            // Cuando el usuario termina de escribir y sale del campo, intentamos aplicar la cantidad
            guestInput.addEventListener("blur", aplicarCantidadPorNombre);


            // ============================
            // 5) ENVÃO DEL FORMULARIO
            // ============================
            form.addEventListener("submit", function (e) {
                e.preventDefault();

                const lado = sideHidden.value || "";
                const invitado = guestInput.value ? guestInput.value.trim() : "";
                const mensaje = extraInfo && extraInfo.value
                    ? extraInfo.value.trim()
                    : "";

                if (!lado) {
                    mostrarAlerta("Falta informaciÃ³n", "Por favor selecciona si eres invitado de la novia o del novio.");
                    return;
                }

                if (!invitado) {
                    mostrarAlerta("Falta tu nombre", "Por favor escribe tu nombre.");
                    return;
                }

                // Verificar que el nombre estÃ© realmente en la lista
                // Buscar el invitado en la lista (objeto con nombre + cantidad)
                const invitadoObj = listaActiva.find(
                    inv => inv.nombre.toLowerCase() === invitado.toLowerCase()
                );

                if (!invitadoObj) {
                    if (notFoundBox) notFoundBox.classList.remove("hidden");
                    mostrarAlerta(
                        "Nombre no encontrado",
                        "Tu nombre no aparece en la lista. Por favor contacta a la novia o al novio ðŸ’›"
                    );
                    return;
                }

                // Nos aseguramos de que la cantidad estÃ© aplicada aunque no haya clic en la sugerencia
                // Si la caja de cantidad nunca se mostrÃ³ (por ejemplo, escribiÃ³ el nombre y no saliÃ³ del input),
                // la mostramos por lo menos una vez con el mÃ¡ximo permitido


                if (guestCountBox && guestCountBox.classList.contains("hidden")) {
                    mostrarCantidad(invitadoObj.cantidad);
                }

                // Tomamos la cantidad que el usuario dejÃ³ seleccionada (si existe el input)
                let cantidadFinal = invitadoObj.cantidad; // valor por defecto

                if (guestCountInput && !guestCountBox.classList.contains("hidden")) {
                    const parsed = parseInt(guestCountInput.value, 10);
                    if (!isNaN(parsed) && parsed >= 1 && parsed <= invitadoObj.cantidad) {
                        cantidadFinal = parsed;
                    }
                }

                // AquÃ­ podrÃ­as hacer un fetch() para guardar la respuesta en tu servidor / Google Sheets
                console.log("Lado:", lado);
                console.log("Invitado:", invitado);
                console.log("Cantidad seleccionada:", cantidadFinal);
                console.log("Mensaje:", mensaje);

                // Enviar a Google Sheets
                // Enviar a Google Sheets SIN JSON, como formulario
                fetch("https://script.google.com/macros/s/AKfycbyIOnkbahQ_yqNA7csFIJNGv5mnwPHhY82hSLPIjQrUcIajzitUTAQtwHpcsbk0mts7Cw/exec", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                    },
                    body: new URLSearchParams({
                        lado: lado,
                        nombre: invitado,
                        cantidad: cantidadFinal,
                        mensaje: mensaje
                    })
                })
                    .then(r => r.text())
                    .then(result => {
                        if (result.trim() === "ok") {
                            console.log("Â¡ConfirmaciÃ³n enviada con Ã©xito! Gracias por confirmar â¤ï¸");
                        } else {
                            console.log("Hubo un pequeÃ±o error: " + result);
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        console.log("Error de conexiÃ³n. Prueba con WhatsApp por favor.");
                    });




                mostrarAlerta(
                    "Â¡Gracias!",
                    "Tu asistencia ha sido confirmada, " + invitado + " ðŸ’›"
                );
                enviarWhatsApp(lado, invitado, cantidadFinal);

                // Reset visual
                form.reset();
                form.classList.add("is-hidden");
                sideHidden.value = "";
                sideLabel.textContent = "";
                suggestionBox.innerHTML = "";
                suggestionBox.style.display = "none";
                if (notFoundBox) notFoundBox.classList.add("hidden");
                if (guestCountBox) guestCountBox.classList.add("hidden");
                cards.forEach(c => c.classList.remove("is-active"));
            });
        });


        // ===============================
        // FUNCIÃ“N PARA MOSTRAR ALERTA BONITA
        // ===============================
        function mostrarAlerta(titulo, mensaje) {
            const alertBox = document.getElementById("niceAlert");
            const titleEl = document.getElementById("niceAlertTitle");
            const messageEl = document.getElementById("niceAlertMessage");
            const buttonEl = document.getElementById("niceAlertBtn");

            if (!alertBox || !titleEl || !messageEl || !buttonEl) {
                // fallback si el modal no existe
                console.warn("No se encontrÃ³ el modal de alerta bonita, usando alert() clÃ¡sico.");
                alert(titulo + "\n\n" + mensaje);
                return;
            }

            titleEl.textContent = titulo;
            messageEl.textContent = mensaje;

            alertBox.classList.remove("hidden");

            buttonEl.onclick = () => {
                alertBox.classList.add("hidden");
            };
        }

        const WHATSAPP_NOVIA = "50258223192";  // ya lo tienes en los links
        const WHATSAPP_NOVIO = "50233970345";

        function enviarWhatsApp(lado, invitado, cantidad) {
            const telefono = lado === "novia" ? WHATSAPP_NOVIA : WHATSAPP_NOVIO;

            const texto = `Hola, soy ${invitado}. 
            Confirmo mi asistencia como invitado de la ${lado === "novia" ? "novia" : "novio"} 
                para ${cantidad} ${cantidad === 1 ? "persona" : "personas"}.`;

            const url = `https://wa.me/${telefono}?text=${encodeURIComponent(texto)}`;
            window.open(url, "_blank");
        }

        // ===============================
        // FUNCIÃ“N PARA MOSTRAR Y CONTROLAR CANTIDAD
        // ===============================
        function mostrarCantidad(maxCantidad) {
            const box = document.getElementById("guestCountBox");
            const guestCount = document.getElementById("guestCount");
            const minus = document.getElementById("btnMinus");
            const plus = document.getElementById("btnPlus");
            const limitLabel = document.getElementById("guestLimitLabel");

            if (!box || !guestCount || !minus || !plus || !limitLabel) {
                console.warn("Faltan elementos para el contador de invitados.");
                return;
            }

            // Setear valor inicial igual a la cantidad mÃ¡xima
            guestCount.value = maxCantidad;

            // Mostrar texto
            limitLabel.textContent =
                maxCantidad === 1
                    ? "InvitaciÃ³n individual."
                    : " personas. Puedes disminuir, pero no aumentar mÃ¡s de " + maxCantidad + " personas.";

            // mostrar caja
            box.classList.remove("hidden");

            // Configurar botÃ³n + (siempre deshabilitado)
            plus.classList.add("disabled");
            plus.disabled = true;

            // BotÃ³n âˆ’ solo deja bajar hasta 1
            minus.onclick = () => {
                let current = parseInt(guestCount.value, 10);
                if (current > 1) {
                    guestCount.value = current - 1;
                }
            };
        }
    </script>



</body>

</html>